---
import type { GetStaticPaths, Page } from "astro";
import { type CollectionEntry, getCollection } from "astro:content";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import HorizontalCard from "../../../../components/HorizontalCard.astro";
import createSlug from "../../../../lib/createSlug";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allProjects = await getCollection("projects");
  
  // Get all unique tags
  const allTags = [...new Set(allProjects.flatMap(project => project.data.tags || []))];
  
  // Create paths for each tag
  return allTags.flatMap(tag => {
    const filteredProjects = allProjects
      .filter(project => project.data.tags?.includes(tag))
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    
    return paginate(filteredProjects, {
      params: { tag: tag },
      pageSize: 10,
    });
  });
};

type Props = {
  page: Page<CollectionEntry<"projects">>;
};

const { page } = Astro.props;
const params = Astro.params;
---

<BaseLayout title={`Projects tagged with "${params.tag}"`} sideBarActiveItemID="projects">
  <div class="mb-5">
    <div class="text-3xl w-full font-bold">Projects tagged with "{params.tag}" ({page.total})</div>
  </div>

  {
    page.data.length === 0 ? (
      <div class="bg-base-200 border-l-4 border-secondary p-4 my-4">
        <p class="font-bold">Sorry!</p>
        <p>There are no projects with this tag. <a href="/projects" class="text-secondary underline">View all projects</a></p>
      </div>
    ) : (
      <div class="grid gap-4">
        {page.data.map((project) => (
          <>
            <HorizontalCard
              title={project.data.title}
              img={project.data.heroImage}
              desc={project.data.description}
              url={"/projects/" + createSlug(project.data.title, project.slug)}
              target="_self"
              badge={project.data.badge}
            />
            <div class="divider my-0" />
          </>
        ))}
      </div>
    )
  }

  <div class="flex justify-between mt-8">
    {
      page.url.prev ? (
        <a href={page.url.prev} class="btn btn-ghost my-10 mx-5">
          <svg
            class="h-6 w-6 fill-current md:h-8 md:w-8"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
          >
            <path d="m7.825 13l4.9 4.9q.3.3.288.7-.013.4-.313.7-.3.275-.7.288-.4.012-.725-.288L6.7 13.7q-.15-.15-.213-.325Q6.425 13.2 6.425 13t.062-.375Q6.55 12.45 6.7 12.3L11.275 7.7q.275-.275.688-.275.412 0 .712.275.275.275.275.7t-.275.7L7.825 13Z" />
          </svg>
          Recent Projects
        </a>
      ) : (
        <div />
      )
    }

    {
      page.url.next ? (
        <a href={page.url.next} class="btn btn-ghost my-10 mx-5">
          Older Projects
          <svg
            class="h-6 w-6 fill-current md:h-8 md:w-8"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
          >
            <path d="m16.175 13l-4.9-4.9q-.3-.3-.288-.7.013-.4.313-.7.3-.275.7-.288.4-.012.725.288L17.3 10.3q.15.15.213.325.062.175.062.375t-.062.375q-.063.175-.213.325L12.725 16.3q-.275.275-.688.275-.412 0-.712-.275-.275-.275-.275-.7t.275-.7L16.175 13Z" />
          </svg>
        </a>
      ) : (
        <div />
      )
    }
  </div>

  <div class="mt-5">
    <a href="/projects" class="btn btn-outline">‚Üê Back to all projects</a>
  </div>
</BaseLayout>